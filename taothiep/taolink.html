<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tạo link thiệp nhiều khách mời (Base64 + QR + Excel)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      input,
      button,
      table {
        margin-top: 10px;
      }
      .guest-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .guest-row input {
        flex: 1;
        padding: 8px;
      }
      button {
        padding: 8px 12px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
        word-break: break-all;
      }
      th {
        background: #f0f0f0;
      }
      .qr-img {
        width: 80px;
        height: 80px;
        cursor: pointer;
      }
      /* popup */
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      #popup .popup-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 50%;
        position: relative;
        text-align: center;
      }
      #popup .close {
        position: absolute;
        top: 8px;
        right: 12px;
        cursor: pointer;
        font-size: 20px;
      }
      #popupQR img {
        width: 150px;
        height: 150px;
        cursor: pointer;
      }
    </style>
    <!-- thư viện tạo QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- thư viện đọc Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>
  <body>
    <label>Link thiệp gốc:</label>
    <input
      id="linkInput"
      type="text"
      placeholder="https://tenmien.com/index01.html"
      style="width: 100%; padding: 8px"
    />

    <h3>Danh sách khách mời</h3>
    <div id="guestList">
      <div class="guest-row">
        <input id="ten" type="text" placeholder="Nhập tên khách mời" />
      </div>
    </div>
    <div>
      <label>
        <input
          type="checkbox"
          id="toggleExcel"
          onchange="toggleExcelUpload()"
        />
        Import khách mời từ Excel
      </label>
      <div id="excelUpload" style="display: none; margin-top: 8px">
        <input
          type="file"
          id="excelFile"
          accept=".xlsx"
          onchange="importExcel()"
        />
        <button
          href="/taothiep/lib/khachmoi.xlsx"
          download
          class="btn btn-outline-success"
        >
          Tải mẫu Excel
        </button>
      </div>
    </div>
    <br />
    <p style="text-align: center">---------------------------------</p>

    <button onclick="addGuest()">+ Thêm khách mời</button>
    <button onclick="generateLinks()">Render link</button>
    <button onclick="exportExcel()">Xuất danh sách ra Excel</button>

    <table id="resultTable" style="display: none">
      <thead>
        <tr>
          <th>Khách mời</th>
          <th>Chi tiết</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Popup -->
    <div id="popup">
      <div class="popup-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <h3 id="popupName"></h3>
        <p>
          <strong>Link:</strong>
          <a
            id="popupLink"
            href="#"
            target="_blank"
            style="
              word-break: break-word;
              overflow-wrap: break-word;
              white-space: normal;
            "
          ></a>
        </p>
        <div id="popupQR" style="margin: 10px 30px"></div>
        <button onclick="copyPopupLink()">Copy link</button>
        <button onclick="downloadPopupQR()">Tải QR PNG</button>
      </div>
    </div>

    <script>
      // Base64 URL-safe encode
      function base64UrlEncode(str) {
        const utf8 = new TextEncoder().encode(str);
        let binary = "";
        const chunkSize = 0x8000;
        for (let i = 0; i < utf8.length; i += chunkSize) {
          binary += String.fromCharCode.apply(
            null,
            Array.from(utf8.subarray(i, i + chunkSize))
          );
        }
        const b64 = btoa(binary);
        return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
      }

      // Add guest input row (có thể bỏ qua check)
      function addGuest(name = "", skipCheck = false) {
        const guestList = document.getElementById("guestList");
        const allInputs = guestList.querySelectorAll("input");

        if (!skipCheck && allInputs.length) {
          const lastInput = allInputs[allInputs.length - 1];
          if (lastInput.value.trim() === "") {
            alert("Vui lòng nhập tên khách mời trước khi thêm mới.");
            lastInput.focus();
            return;
          }
        }

        const div = document.createElement("div");
        div.className = "guest-row";
        div.innerHTML = `<input type="text" placeholder="Nhập tên khách mời" value="${name}">`;
        guestList.appendChild(div);
      }

      function toggleExcelUpload() {
        const checkbox = document.getElementById("toggleExcel");
        const excelUpload = document.getElementById("excelUpload");

        if (checkbox.checked) {
          // Nếu check → hiện input file
          excelUpload.style.display = "block";

          // Xoá ô cuối nếu trống
          const guestList = document.getElementById("guestList");
          const allInputs = guestList.querySelectorAll("input");
          if (allInputs.length) {
            const lastInput = allInputs[allInputs.length - 1];
            if (lastInput.value.trim() === "") {
              // Xoá cả .guest-row chứa nó
              const lastRow = lastInput.closest(".guest-row");
              if (lastRow) guestList.removeChild(lastRow);
            }
          }
        } else {
          // Bỏ check → ẩn input file
          excelUpload.style.display = "none";
        }
      }

      function importExcel() {
        const file = document.getElementById("excelFile").files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          rows.forEach((row, idx) => {
            if (idx === 0) return;
            const name = row[0];
            if (name && name.toString().trim() !== "") {
              addGuest(name, true); // skipCheck = true
            }
          });
        };
        reader.readAsArrayBuffer(file);
      }

      let lastResults = [];

      function generateLinks() {
        const link = document.getElementById("linkInput").value.trim();
        const ten = document.getElementById("ten").value.trim();
        if (!link) {
          alert("Vui lòng nhập link thiệp gốc.");
          return;
        }
        if (!ten) {
          alert("Vui lòng nhập tên khách mời.");
          return;
        }

        const inputs = document.querySelectorAll("#guestList input");
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        inputs.forEach((input) => {
          const name = input.value.trim();
          if (!name) return;

          const payload = name + "|" + Date.now();
          const encoded = base64UrlEncode(payload);
          const finalLink = link.includes("?")
            ? `${link}&khachmoi=${encoded}`
            : `${link}?khachmoi=${encoded}`;

          const tr = document.createElement("tr");
          // dùng encodeURIComponent để tránh lỗi ký tự đặc biệt
          tr.innerHTML = `
      <td>${name}</td>
      <td><button onclick="showDetails('${encodeURIComponent(
        name
      )}','${finalLink}')">Chi tiết</button></td>
    `;
          tbody.appendChild(tr);
        });

        document.getElementById("resultTable").style.display = "table";
      }

      function showDetails(nameEncoded, link) {
        const name = decodeURIComponent(nameEncoded);
        document.getElementById("popupName").textContent = name;

        const popupLink = document.getElementById("popupLink");
        popupLink.textContent = link;
        popupLink.href = link;
        popupLink.dataset.copy = link;

        // tạo QR mới
        const popupQR = document.getElementById("popupQR");
        popupQR.innerHTML = "";
        new QRCode(popupQR, {
          text: link,
          width: 150,
          height: 150,
        });

        document.getElementById("popup").style.display = "flex";
      }

      function closePopup() {
        document.getElementById("popup").style.display = "none";
      }

      function copyPopupLink() {
        const link = document.getElementById("popupLink").dataset.copy;
        navigator.clipboard
          .writeText(link)
          .then(() => alert("Đã copy link:\n" + link))
          .catch(() => prompt("Copy thủ công:", link));
      }

      function downloadPopupQR() {
        const img = document.querySelector("#popupQR img");
        const name = document.getElementById("popupName").textContent;
        if (img) {
          const link = document.createElement("a");
          link.href = img.src;
          link.download = `QR_${name.replace(/\s+/g, "_")}.png`;
          link.click();
        }
      }

      function exportExcel() {
        if (!lastResults.length) {
          alert("Chưa có dữ liệu để xuất.");
          return;
        }
        const ws = XLSX.utils.json_to_sheet(
          lastResults.map((item) => ({
            "Tên khách mời": item.name,
            "Link thiệp": item.link,
          }))
        );
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DanhSach");
        XLSX.writeFile(wb, "DanhSach_Thiệp.xlsx");
      }
    </script>
  </body>
</html>
